version: 2
jobs:
  build:
    working_directory: ~/circleci-demo-ruby-rails
    docker:
      - image: circleci/ruby:2.4.1-node
        environment:
          RAILS_ENV: test
          PGHOST: 127.0.0.1
          PGUSER: root
      - image: circleci/postgres:9.6.2-alpine
        environment:
          POSTGRES_USER: root
          POSTGRES_DB: circle-test_test
    steps:
      - checkout

      # Restore bundle cache
      - restore_cache:
          keys:
            - rails-demo-{{ checksum "Gemfile.lock" }}
            - rails-demo-

      # Bundle install dependencies
      - run:
          name: Install dependencies
          command: bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs 4 --retry 3

      - run: sudo apt install postgresql-client

      # Store bundle cache
      - save_cache:
          key: rails-demo-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle

      - run:
          name: Database Setup
          command: |
            bundle exec rake db:create
            bundle exec rake db:migrate
      - run:
          name: Run All Test
          command: DISABLE_SPRING=true bin/rake test test/

      - run:
          name: Deploy to heroku
          branch: master
          command: |
            if ["${CIRCLE_BRANCH }" == "master" ]; then
              echo 'heroku.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAtixaa1vi2Q1k2Au9vtpFBl2Xi9FHzoOxZzOze+RXRq85//UsoN3K7xSlx6QcL3Fc4rOuhzysAul1OUO5HxVUIuS2MLYLq6/wPbKCT2KwYteKideDBkIz3rxHDwWCr19mUG22LPV0DK0e51jHtJfSz61DWrmE8b1ikEp1XkSp5VVcLpCVooSZg7L/VvG6WUIsdwymQKDNGYhn/aVoXu9889GB+cBOtJeaQH6Rsvab5BwMt6e2REpLyWMvcv3NwKyK9VVlu6VB6aT6G/rmunBFMTnDIrulJzdpO+Wnvhdl9MI1nixmyp9URuUZnFt8x1k556whJ3YxeSAKzy3k32lp1Q== dstanza@DSTANZA-PC' >> ~/.ssh/known_hosts
              git push git@heroku.com:dstanza-kampus-ror-dstanza.git master
            fi

          # heroku config:add gmail_user_name=didi_stanza@gmail.com gmail_password=xxxxxxxx
          # heroku config:add FACEBOOK_KEY=xxxx FACEBOOK_SECRET=xxxx
